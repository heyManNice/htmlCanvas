
<script>
    function log(...args){
        console.log(...args);
    }
    class DataDrivenView {
        #variables = {};
        #functions = {};
        #template = null;
        constructor(){
            window.addEventListener('load',this.#render.bind(this));
        }

        /**
         * 设置数据
         * @param {{[key: string]:any}} data
         */
        setData(data){
            for(const key in data){
                this.#variables[key] = this.#response(data[key]);
            }
        }

        /**
         * 设置函数
         * @param {{[key: string]:Function}} func
         */
        setFunc(func){
            for(const key in func){
                this.#functions[key] = func[key]; 
            }  
        }

        /**
         * 创建响应式对象
         * @param {any} value
         * @returns {Proxy}
         */
        #response(value){
            const that = this;
            const obj = {value}
            return new Proxy(obj,{
                set(target,key,value){
                    target.value = value;
                    that.#render();
                    return true;
                }
            });
        }

        /**
         * 渲染页面
         * @returns {void}
         */
        #render(){
            if(!this.#template){
                this.#template = document.querySelector('template');
                this.#template.parentNode.removeChild(this.#template);
            }
            const childNodes = this.#template.content.childNodes;
            const fragment = document.createDocumentFragment();
            
            for(let i = 0; i < childNodes.length; i++){
                fragment.appendChild(childNodes[i].cloneNode(true));
            }

            const walker = document.createTreeWalker(fragment,NodeFilter.SHOW_ALL,null,false);

            while(walker.nextNode()){
                const node = walker.currentNode;
                if(node.nodeType === Node.TEXT_NODE){
                    this.#parseTextContent(node); 
                }else if(node.nodeType === Node.ELEMENT_NODE){
                    this.#parseElementAttribute(node); 
                }
                
            }
            const body = document.querySelector('body');
            body.replaceChildren(...fragment.childNodes);
            
            
        }
        /**
         * 解析文字内容
         * @param {Node} node
         */
        #parseTextContent(node){
            const text = node.textContent;
            if(!text.includes('__')) return;
            node.textContent = text.replace(/__[a-zA-Z_$][a-zA-Z0-9_$]*__/g,(matched) => {
                const key = matched.slice(2,-2);
                const variable = this.#variables[key];
                if(!variable) return matched;
                log("[变量]",key,'=',variable.value);
                return variable.value;
            });
        }
        /**
         * 解析元素属性
         * @param {Node} node
         */
        #parseElementAttribute(node){
            const attrs = node.attributes;
            if(!attrs.length) return;
            for(const attr of attrs){
                const {name,value} = attr;
                if(!name.includes('__')) continue;
                const event = name.slice(2);
                log("[事件]",event);
                
                node.addEventListener(event,()=>{
                    this.#functions[value].call(this.#variables);
                });
                node.removeAttribute(name);
            }
        }
    }

</script>

<template>
    <p>__msg__</p>
    <div>
        <p class="count">__count__</p>
        <button __click="increment" >+1</button>
    </div>
</template>

<script>
    const ddv = new DataDrivenView();

    ddv.setData({
        msg:"这个页面不是canvas练习，而是数据驱动视图原理练习，我不知道放哪儿了就随便放在这",
        count:0
    });

    ddv.setFunc({
        increment(){
            this.count.value++;
        }
    });
</script>

<style>
    body{
        margin: 0;
        padding: 2rem;
        text-align: center;
    }
    .count{
        font-size: 3rem;    
    }
</style>
  