<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>elasticWindow</title>
    <style>
        *{
            margin: 0;
            padding: 0;
        }
        canvas{
            background: #fff;
            display: block;
            height: 100vh;
            width: 100vw;
        }
    </style>
</head>
<body>
    <canvas></canvas>
</body>
<script>
class Widget{
    parent;
    children=[];
    // 相对父窗口的位置
    x = 0;
    y = 0;
    absoluteX;
    absoluteY;


    width = 10;
    height = 10;

    backgroundColor="#000";
    name;
    
    constructor(parent){
        this.parent=parent;
        if(parent){
            parent.children.push(this); 
        }
    }
    setPos(x,y){
        this.x=x;
        this.y=y;
        return this; 
    }
    onDraw(params){
        
    }
    _loop(){
        this.absoluteX=this.x+this.parent.absoluteX;
        this.absoluteY=this.y+this.parent.absoluteY;
        for(const child of this.children){
            child._loop(); 
        }
    }
    _draw(params){
        const {mouse,graphics}=params;
        this.onDraw(params);
        for(const child of this.children){
            child._draw(params);
        }
    }
    _mouseDown(params){
        if(this.onMouseDown){
            this.onMouseDown(params);
        }
        for(const child of this.children){
            if(child.isInArea(params.mouse.absoluteX,params.mouse.absoluteY)){
                child._mouseDown(params); 
            }
        }
    }
    _mouseUp(params){
        if(this.onMouseUp){
            this.onMouseUp(params);
        }
        for(const child of this.children){
            if(child.isInArea(params.mouse.absoluteX,params.mouse.absoluteY)){
                child._mouseUp(params); 
            }
        }
    }
    setSize(width,height){
        this.width=width;
        this.height=height;
        return this; 
    }
    isInArea(x,y){
        return x>this.x&&x<this.x+this.width&&y>this.y&&y<this.y+this.height; 
    }
}

class Desktop extends Widget{
    absoluteX=0;
    absoluteY=0;
    x=0;
    y=0;
    canvas;
    graphics;
    constructor(canvas){
        super(null);
        this.canvas=canvas;
        this.graphics=canvas.getContext('2d');
        this.ratio = window.devicePixelRatio || 1;
        this.width = this.canvas.width = window.innerWidth*this.ratio;
        this.height = this.canvas.height = window.innerHeight*this.ratio;
        this.canvas.addEventListener('mousemove', (e) => {
            this.mouseX = e.clientX*this.ratio;
            this.mouseY = e.clientY*this.ratio;
        });
        this.canvas.addEventListener('mousedown', (e) => {
            const params = {
                mouse:{
                    absoluteX:this.mouseX,
                    absoluteY:this.mouseY
                },
                graphics:this.graphics,
                ratio:this.ratio 
            }
            if(this.onMouseDown){
                this.onMouseDown(params); 
            }
            for(const child of this.children){
                if(child.isInArea(params.mouse.absoluteX,params.mouse.absoluteY)){
                    child._mouseDown(params);
                } 
            }
        });
        this.canvas.addEventListener('mouseup', (e) => {
            const params = {
                mouse:{
                    absoluteX:this.mouseX,
                    absoluteY:this.mouseY
                },
                graphics:this.graphics,
                ratio:this.ratio 
            }
            if(this.onMouseUp){
                this.onMouseUp(params); 
            }
            for(const child of this.children){
                if(child.isInArea(params.mouse.absoluteX,params.mouse.absoluteY)){
                    child._mouseUp(params);
                }
            }
        })
        this._loop();
    }

    _loop(){
        this.graphics.clearRect(0, 0, this.width, this.height);
        const params = {
            mouse:{
                absoluteX:this.mouseX,
                absoluteY:this.mouseY
            },
            graphics:this.graphics,
            ratio:this.ratio
        };
        for(const child of this.children){
            child._loop();
        }
        this._draw(params);
        requestAnimationFrame(()=>{this._loop()});
    }
}

class Window extends Widget{
    mouseClientPos={x:0,y:0};
    mouseStatus=void 0;
    mouseStatusChangePos={x:0,y:0};
    constructor(parent){
        super(parent);
        this.x=100;
        this.y=100;
        this.width=800;
        this.height=600;
    }
    onDraw(params){
        const {mouse,graphics}=params;
        if(this.mouseStatus==="down"){
            this.x=mouse.absoluteX-this.mouseStatusChangeClientPos.x;
            this.y=mouse.absoluteY-this.mouseStatusChangeClientPos.y;
        }
        
        graphics.fillStyle=this.backgroundColor;
        graphics.strokeRect(this.x,this.y,this.width,this.height);
    }
    onMouseDown(params){
        const {absoluteX,absoluteY} = params.mouse;
        this.mouseStatusChangeClientPos = {x:absoluteX-this.x,y:absoluteY-this.y};
        this.mouseStatus = "down";
    }
    onMouseUp(params){
        const {absoluteX,absoluteY} = params.mouse;
        this.mouseStatusChangeClientPos = {absoluteX,absoluteY};
        this.mouseStatus = "up";
    }
}

const desktop = new Desktop(document.querySelector('canvas'));
const win = new Window(desktop);
const w = new Widget(win);
w.onDraw=function(params){
    const {mouse,graphics}=params;
    graphics.fillStyle="#f00";
    graphics.fillRect(this.absoluteX,this.absoluteY,this.width,this.height); 
}
w.setPos(100,100);
w.setSize(200,150);
</script>
</html>