<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>elasticWindow</title>
    <style>
        *{
            margin: 0;
            padding: 0;
        }
        canvas{
            background: #fff;
            display: block;
            height: 100vh;
            width: 100vw;
        }
    </style>
</head>
<body>
    <canvas></canvas>
</body>
<script>
class Widget{
    parent;
    children=[];
    // 相对父窗口的位置
    x = 0;
    y = 0;
    absoluteX;
    absoluteY;


    width = 10;
    height = 10;

    backgroundColor="#000";
    name;
    
    constructor(parent){
        this.parent=parent;
        if(parent){
            parent.children.push(this); 
        }
    }
    setPos(x,y){
        this.x=x;
        this.y=y;
        return this; 
    }
    onDraw(){
        
    }
    _loop(){
        this.absoluteX=this.x+this.parent.absoluteX;
        this.absoluteY=this.y+this.parent.absoluteY;
        for(const child of this.children){
            child._loop(); 
        }
    }
    _draw(){
        const {mouse,graphics}=app;
        this.onDraw(app);
        for(const child of this.children){
            child._draw();
        }
    }
    _mouseDown(){
        if(this.onMouseDown){
            this.onMouseDown();
        }
        for(const child of this.children){
            if(child.isInArea(app.mouse.absoluteX,app.mouse.absoluteY)){
                child._mouseDown(); 
            }
        }
    }
    _mouseUp(){
        if(this.onMouseUp){
            this.onMouseUp();
        }
        for(const child of this.children){
            if(child.isInArea(app.mouse.absoluteX,app.mouse.absoluteY)){
                child._mouseUp(); 
            }
        }
    }
    setSize(width,height){
        this.width=width;
        this.height=height;
        return this; 
    }
    isInArea(x,y){
        return x>this.x&&x<this.x+this.width&&y>this.y&&y<this.y+this.height; 
    }
}

class Application{
    children=[];
    mouse={
        absoluteX:0,
        absoluteY:0
    }
    constructor(element){
        if(!element||element.nodeName !== 'CANVAS'){
            throw new Error(`canvas element is required, but received ${element ? element.nodeName : 'null'}`);
        }
        if(!window.app){
            // 定义app 并且不可重新赋值
            const that=this;
            Object.defineProperty(window, 'app', {
            configurable: false,
            enumerable: true,
            get() {
                return that;
            },
            set() {
                throw new Error("window.app is already defined and cannot be reassigned.");
            }
        });
        }else if(window.app instanceof Application === false){
            throw new Error(`window.app (instance of ${window.app.constructor.name}) is already defined. The Application requires it to implement a singleton pattern. Please avoid using the 'app' variable under the window object.`); 
        }else{
            // 返回存在的单例
            return window.app; 
        }
        this.canvas=element;
        this.graphics=this.canvas.getContext('2d');
        this.ratio = window.devicePixelRatio || 1;
        this.monitor= {
            width:window.innerWidth*this.ratio,
            height:window.innerHeight*this.ratio
        }
        this.canvas.width=this.monitor.width;
        this.canvas.height=this.monitor.height;
        this.canvas.addEventListener('mousemove', (e) => {
            this.mouse.absoluteX = e.clientX*this.ratio;
            this.mouse.absoluteY = e.clientY*this.ratio;
        });
        this.canvas.addEventListener('mousedown', (e) => {
            for(const child of this.children){
                if(child.isInArea(app.mouse.absoluteX,app.mouse.absoluteY)){
                    child._mouseDown();
                } 
            }
        });
        this.canvas.addEventListener('mouseup', (e) => {
            for(const child of this.children){
                if(child.isInArea(app.mouse.absoluteX,app.mouse.absoluteY)){
                    child._mouseUp();
                }
            }
        })
    }
}


class Desktop extends Widget{
    absoluteX=0;
    absoluteY=0;
    x=0;
    y=0;
    canvas;
    graphics;
    constructor(app){
        if(!app||app instanceof Application === false){
            throw new Error(`Application is required, but received ${app? app.constructor.name : 'null'}`); 
        }
        super(null);
        this.width = app.monitor.width;
        this.height = app.monitor.height;
        app.children.push(this);
        this._loop();
    }

    _loop(){
        app.graphics.clearRect(0, 0, this.width, this.height);
        for(const child of this.children){
            child._loop();
        }
        this._draw();
        requestAnimationFrame(()=>{this._loop()});
    }
}

class Window extends Widget{
    mouseClientPos={x:0,y:0};
    mouseStatus=void 0;
    mouseStatusChangePos={x:0,y:0};
    constructor(parent){
        super(parent);
        this.x=100;
        this.y=100;
        this.width=800;
        this.height=600;
    }
    onDraw(){
        const {mouse,graphics}=app;
        if(this.mouseStatus==="down"){
            this.x=mouse.absoluteX-this.mouseStatusChangeClientPos.x;
            this.y=mouse.absoluteY-this.mouseStatusChangeClientPos.y;
        }
        
        graphics.fillStyle=this.backgroundColor;
        graphics.strokeRect(this.x,this.y,this.width,this.height);
    }
    onMouseDown(){
        const {absoluteX,absoluteY} = app.mouse;
        this.mouseStatusChangeClientPos = {x:absoluteX-this.x,y:absoluteY-this.y};
        this.mouseStatus = "down";
    }
    onMouseUp(){
        const {absoluteX,absoluteY} = app.mouse;
        this.mouseStatusChangeClientPos = {absoluteX,absoluteY};
        this.mouseStatus = "up";
    }
}

const app = new Application(document.querySelector('canvas'));
const desktop = new Desktop(app);
const win = new Window(desktop);
const w = new Widget(win);
w.onDraw=function(app){
    const {mouse,graphics}=app;
    graphics.fillStyle="#f00";
    graphics.fillRect(this.absoluteX,this.absoluteY,this.width,this.height); 
}
w.setPos(100,100);
w.setSize(200,150);
</script>
</html>